"use strict";

$(document).ready(function() {
  // Validación de formularios por sección
  $("#project-type").validate();
  $("#project-details").validate();
  $("#project-settings").validate();
  $("#project-budgets").validate();

  // Configuración del wizard de pasos
  $("#project-create-steps").steps({
    headerTag: "div.step-title",
    bodyTag: "section.step-body",
    transitionEffect: "slideLeft",
    titleTemplate: "#title#",
    enableAllSteps: true,
    
    // Validación al cambiar de paso
    onStepChanging: function(event, currentIndex, newIndex) {
      if (newIndex < currentIndex) return true;
      
      const $currentForm = $(".body.current form");
      if ($currentForm.length === 1) {
        $currentForm.validate().settings.ignore = ":disabled,:hidden";
        return $currentForm.valid();
      }
      return true;
    },
    
    // Validación al finalizar
    onFinishing: function(event, currentIndex) {
      const $currentForm = $(".body.current form");
      if ($currentForm.length === 1) {
        $currentForm.validate().settings.ignore = ":disabled";
        return $currentForm.valid();
      }
      return true;
    },
    
    // Acción al completar todos los pasos
    onFinished: function(event, currentIndex) {
      const swal = Swal.mixin({
        customClass: {
          confirmButton: "btn btn-success m-1",
          cancelButton: "btn btn-danger m-1"
        },
        buttonsStyling: false
      });
      
      swal.fire({
        title: "¿Crear y Finalizar?",
        text: "¿Estás seguro de que deseas crear este proyecto?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Sí, ¡Crear proyecto!",
        cancelButtonText: "No, cancelar",
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          swal.fire(
            "¡Proyecto Creado!",
            "El proyecto se ha creado correctamente.",
            "success"
          ).then(() => {
            // Aquí iría la lógica para crear el proyecto
            console.log("Proyecto creado");
          });
        } else if (result.dismiss === Swal.DismissReason.cancel) {
          swal.fire(
            "Cancelado",
            "El proyecto no fue creado.",
            "error"
          );
        }
      });
    }
  });

  // Selectores con formato personalizado
  $("#projectClient, #tragetAssigned").select2({
    theme: "bootstrap-5",
    templateResult: userformat,
    templateSelection: userformat
  });

  $("#billingType, #projectStatus, #projectTags, #tragetTags, [data-select2-teammates='teammates']").select2({
    theme: "bootstrap-5",
    templateResult: bgformat,
    templateSelection: bgformat
  });

  $("#sendcontactsNotifications").select2({
    theme: "bootstrap-5",
    templateResult: iformat,
    templateSelection: iformat
  });

  // Editores de texto enriquecido
  new Quill("#projectDescription", {
    placeholder: "Describa el proyecto...",
    theme: "snow"
  });

  new Quill("#targetDescription", {
    placeholder: "Describa el objetivo...",
    theme: "snow"
  });

  // Selectores de fecha
  const projectReleaseDate = document.getElementById("projectReleaseDate");
  const targetReleaseDate = document.getElementById("targetReleaseDate");
  
  new Datepicker(projectReleaseDate, {
    clearBtn: true,
    allowOneSidedRange: true,
    language: "es" // Configuración para español
  });

  new Datepicker(targetReleaseDate, {
    clearBtn: true,
    allowOneSidedRange: true,
    language: "es" // Configuración para español
  });

  // Manejo de archivos adjuntos
  $("#choose-file").change(function() {
    const fileName = $(this)[0].files[0]?.name || "Seleccionar archivo";
    $(this).prev("label").text(fileName);
  });
});