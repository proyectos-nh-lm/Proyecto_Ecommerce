"use strict";

$(document).ready(function() {
  // ======================
  // 1. EDITOR DE TEXTO
  // ======================
  const initTextEditor = () => {
    try {
      new Quill('[data-editor-target="editor"]', {
        placeholder: "Redacta tu propuesta aquí...",
        theme: "snow",
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline'],
            ['link', 'blockquote'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }]
          ]
        }
      });
    } catch (error) {
      console.error("Error al inicializar el editor:", error);
    }
  };

  // ======================
  // 2. ALERTA DE CONFIRMACIÓN
  // ======================
  const initConfirmationAlert = () => {
    $('[data-alert-target="#alertMessage"]').on("click", function(event) {
      event.preventDefault();
      
      const swal = Swal.mixin({
        customClass: {
          confirmButton: "btn btn-success m-1",
          cancelButton: "btn btn-danger m-1"
        },
        buttonsStyling: false
      });
      
      swal.fire({
        title: "¿Confirmar envío?",
        text: "¿Estás seguro de querer enviar esta propuesta?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Sí, enviar",
        cancelButtonText: "No, cancelar",
        reverseButtons: true,
        backdrop: `
          rgba(0,0,0,0.7)
          url("/images/loading.gif")
          center left
          no-repeat
        `,
        allowOutsideClick: false
      }).then((result) => {
        if (result.isConfirmed) {
          // Lógica para enviar la propuesta
          sendProposal().then(() => {
            swal.fire(
              "¡Enviado!",
              "La propuesta se ha enviado correctamente.",
              "success"
            );
          }).catch(() => {
            swal.fire(
              "Error",
              "Ocurrió un problema al enviar la propuesta.",
              "error"
            );
          });
        } else {
          swal.fire(
            "Operación cancelada",
            "La propuesta no fue enviada.",
            "info"
          );
        }
      });
    });
  };

  // Función simulada para enviar la propuesta
  const sendProposal = () => {
    return new Promise((resolve) => {
      // Simular envío asíncrono
      setTimeout(resolve, 1500);
    });
  };

  // ======================
  // 3. SELECTORES DE FECHA
  // ======================
  const initDatePickers = () => {
    try {
      const startDateEl = document.getElementById("startDate");
      const dueDateEl = document.getElementById("dueDate");
      
      if (!startDateEl || !dueDateEl) {
        throw new Error("Elementos de fecha no encontrados");
      }

      new Datepicker(startDateEl, {
        clearBtn: true,
        allowOneSidedRange: true,
        language: "es",
        format: "dd/mm/yyyy",
        autohide: true
      });

      new Datepicker(dueDateEl, {
        clearBtn: true,
        allowOneSidedRange: true,
        language: "es",
        format: "dd/mm/yyyy",
        autohide: true
      });
    } catch (error) {
      console.error("Error en selectores de fecha:", error);
    }
  };

  // ======================
  // INICIALIZACIÓN
  // ======================
  initTextEditor();
  initConfirmationAlert();
  initDatePickers();
});