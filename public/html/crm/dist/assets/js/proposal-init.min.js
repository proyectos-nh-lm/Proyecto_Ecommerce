"use strict";

$(document).ready(function() {
  // ======================================
  // 1. CIRCULAR PROGRESS BARS (BARRAS DE PROGRESO CIRCULARES)
  // ======================================
  const initProgressCircles = () => {
    const progressData = [
      { selector: ".progress-1", value: 50, text: "$450 USD" },
      { selector: ".progress-2", value: 60, text: "$550 USD" },
      { selector: ".progress-3", value: 70, text: "$850 USD" },
      { selector: ".progress-4", value: 80, text: "$900 USD" }
    ];

    progressData.forEach(item => {
      $(item.selector).circleProgress({
        max: 100,
        value: item.value,
        textFormat: () => item.text,
        animation: { duration: 1500 },
        fill: { gradient: ["#3454d1", "#25b865"] }
      });
    });
  };

  // ======================================
  // 2. DATA TABLE FOR PROPOSALS (TABLA DE PROPUESTAS)
  // ======================================
  const initProposalsTable = () => {
    $("#proposalList").DataTable({
      pageLength: 10,
      lengthMenu: [10, 20, 50, 100, 200, 500],
      language: {
        search: "Buscar:",
        lengthMenu: "Mostrar _MENU_ propuestas",
        info: "Mostrando _START_ a _END_ de _TOTAL_ propuestas",
        infoEmpty: "No hay propuestas disponibles",
        zeroRecords: "No se encontraron resultados"
      }
    });
  };

  // ======================================
  // 3. CHECKBOX SELECTION LOGIC (LÓGICA DE SELECCIÓN)
  // ======================================
  const initCheckboxSelection = () => {
    // Seleccionar/Deseleccionar todos
    $("#checkAllProposal").change(function() {
      const isChecked = this.checked;
      $(".checkbox").each(function() {
        this.checked = isChecked;
        $(this).closest(".single-items").toggleClass("selected", isChecked);
      });
    });

    // Manejar selección individual
    $(".checkbox").on("click", function() {
      const allChecked = $(".checkbox:checked").length === $(".checkbox").length;
      $("#checkAllProposal").prop("checked", allChecked);
    });

    // Alternar clase 'selected' al hacer clic
    $(".items-wrapper").on("click", "input:checkbox", function() {
      $(this).closest(".single-items").toggleClass("selected", this.checked);
    });

    // Inicializar elementos ya seleccionados
    $(".items-wrapper input:checkbox:checked").closest(".single-items").addClass("selected");
  };

  // ======================================
  // 4. RICH TEXT EDITOR (EDITOR DE TEXTO ENRIQUECIDO)
  // ======================================
  const initTextEditor = () => {
    new Quill('[data-editor-target="editor"]', {
      placeholder: "Redacta tu propuesta aquí...",
      theme: "snow",
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline'],
          ['link', 'blockquote'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }]
        ]
      }
    });
  };

  // ======================================
  // 5. PROPOSAL CONFIRMATION ALERT (ALERTA DE CONFIRMACIÓN)
  // ======================================
  const initConfirmationAlert = () => {
    $('[data-alert-target="alertMessage"]').on("click", function(e) {
      e.preventDefault();
      
      const swal = Swal.mixin({
        customClass: {
          confirmButton: "btn btn-success m-1",
          cancelButton: "btn btn-danger m-1"
        },
        buttonsStyling: false
      });
      
      swal.fire({
        title: "¿Confirmar envío?",
        text: "¿Estás seguro de querer enviar esta propuesta?",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Sí, enviar",
        cancelButtonText: "No, cancelar",
        reverseButtons: true,
        allowOutsideClick: false
      }).then(result => {
        if (result.isConfirmed) {
          swal.fire(
            "¡Enviado!",
            "La propuesta se ha enviado correctamente.",
            "success"
          );
        } else if (result.dismiss === Swal.DismissReason.cancel) {
          swal.fire(
            "Cancelado",
            "La propuesta no fue enviada.",
            "error"
          );
        }
      });
    });
  };

  // ======================================
  // INITIALIZE ALL COMPONENTS (INICIALIZAR TODOS LOS COMPONENTES)
  // ======================================
  initProgressCircles();
  initProposalsTable();
  initCheckboxSelection();
  initTextEditor();
  initConfirmationAlert();
});