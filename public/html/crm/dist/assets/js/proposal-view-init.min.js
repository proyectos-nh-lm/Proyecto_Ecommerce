"use strict";

$(document).ready(function() {
  // ======================================
  // 1. INICIALIZACIÓN DE EDITORES DE TEXTO
  // ======================================
  const initTextEditors = () => {
    try {
      // Configuración común para ambos editores
      const editorConfig = {
        placeholder: "Redacta tu contenido aquí...",
        theme: "snow",
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline'],
            ['link', 'blockquote'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['clean']
          ]
        }
      };

      // Inicializar editor principal
      new Quill('[data-editor-target="editor"]', editorConfig);

      // Inicializar editor de propuestas
      new Quill('[data-editor-target="editor-proposal"]', {
        ...editorConfig,
        placeholder: "Redacta tu propuesta aquí..."
      });

    } catch (error) {
      console.error("Error al inicializar editores:", error);
      Swal.fire({
        title: "Error",
        text: "No se pudo cargar el editor de texto",
        icon: "error"
      });
    }
  };

  // ======================================
  // 2. ALERTA DE CONFIRMACIÓN DE PROPUESTA
  // ======================================
  const initProposalConfirmation = () => {
    $('[data-alert-target="#alertMessage"]').on("click", function(e) {
      e.preventDefault();
      
      const swal = Swal.mixin({
        customClass: {
          confirmButton: "btn btn-success m-1",
          cancelButton: "btn btn-danger m-1"
        },
        buttonsStyling: false
      });
      
      swal.fire({
        title: "¿Confirmar envío?",
        text: "¿Estás seguro de querer enviar esta propuesta? Esta acción no se puede deshacer.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Sí, enviar propuesta",
        cancelButtonText: "No, cancelar",
        reverseButtons: true,
        allowOutsideClick: false,
        backdrop: `
          rgba(0,0,0,0.7)
          url("/images/loading.gif")
          center left
          no-repeat
        `,
        showLoaderOnConfirm: true,
        preConfirm: () => {
          return new Promise((resolve) => {
            // Simular envío asíncrono
            setTimeout(() => {
              resolve();
            }, 1500);
          });
        }
      }).then((result) => {
        if (result.isConfirmed) {
          swal.fire({
            title: "¡Enviado!",
            text: "La propuesta se ha enviado correctamente.",
            icon: "success",
            timer: 2000,
            showConfirmButton: false
          });
        } else if (result.dismiss === Swal.DismissReason.cancel) {
          swal.fire({
            title: "Cancelado",
            text: "La propuesta no fue enviada.",
            icon: "info",
            timer: 2000,
            showConfirmButton: false
          });
        }
      });
    });
  };

  // ======================================
  // INICIALIZAR TODOS LOS COMPONENTES
  // ======================================
  initTextEditors();
  initProposalConfirmation();
});